<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kehua Memories - </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- 主题变量定义 --- */
        :root {
            /* 动画曲线 */
            --spring-easing: cubic-bezier(0.25, 1, 0.5, 1);
            --bouncy-easing: cubic-bezier(0.175, 0.885, 0.32, 1.275);

            /* 默认暗色主题 (Dark Mode) */
            --bg-color: #000;
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-tertiary: rgba(255, 255, 255, 0.4);
            
            --card-bg: rgba(44, 44, 46, 0.6);
            --card-border: rgba(255, 255, 255, 0.1);
            --card-hover-bg: rgba(58, 58, 60, 0.8);
            
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);

            --accent-icon-bg: rgba(255, 255, 255, 0.05);
            --year-title-opacity: 0.1;
        }

        /* 亮色主题 (Light Mode) */
        [data-theme="light"] {
            --bg-color: #f2f2f7;
            --bg-gradient-start: #e0eafc;
            --bg-gradient-end: #cfdef3;
            
            --text-primary: #1c1c1e;
            --text-secondary: rgba(60, 60, 67, 0.6);
            --text-tertiary: rgba(60, 60, 67, 0.3);
            
            --card-bg: rgba(255, 255, 255, 0.65);
            --card-border: rgba(255, 255, 255, 0.4);
            --card-hover-bg: rgba(255, 255, 255, 0.85);
            
            --glass-bg: rgba(255, 255, 255, 0.4);
            --glass-border: rgba(255, 255, 255, 0.2);

            --accent-icon-bg: rgba(0, 0, 0, 0.05);
            --year-title-opacity: 0.05;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "PingFang SC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            user-select: none;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* 视差背景 */
        #parallax-bg {
            position: fixed;
            inset: -50px;
            z-index: -1;
            background-size: cover;
            background-position: center;
            filter: brightness(0.6) blur(20px);
            transition: transform 0.1s linear, filter 0.5s ease;
            background-image: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
        }
        
        [data-theme="light"] #parallax-bg {
            filter: brightness(1.1) blur(30px);
        }

        /* 磨砂玻璃容器 */
        .glass-container {
            background: var(--glass-bg);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 0.5px solid var(--glass-border);
            transition: background 0.5s ease, border 0.5s ease;
        }

        /* iOS 卡片 */
        .ios-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 22px;
            transition: all 0.5s var(--spring-easing), background 0.5s ease, border-color 0.5s ease;
            border: 0.5px solid var(--card-border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); /* 阴影变淡一点以适应亮色 */
            overflow: hidden;
        }

        .ios-card:hover {
            transform: scale(1.015) translateY(-5px);
            background: var(--card-hover-bg);
            border-color: var(--text-tertiary);
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        }

        /* 进场动画 */
        @keyframes ios-reveal {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .reveal {
            animation: ios-reveal 0.8s var(--spring-easing) forwards;
        }

        /* 媒体查询优化 */
        .media-content {
            border-radius: 8px; /*稍微改小圆角适应九宫格*/
            overflow: hidden;
            background: rgba(0,0,0,0.05);
            position: relative;
        }

        /* 九宫格布局 */
        .grid-gallery {
            display: grid;
            gap: 4px;
            grid-template-columns: repeat(3, 1fr);
        }
        /* 当只有4张图时，使用2列布局 (仿朋友圈) */
        .grid-gallery.four-grid {
            grid-template-columns: repeat(2, 1fr);
            width: 66%; /* 限制宽度 */
        }
        
        /* 单张大图 */
        .single-image-container {
            border-radius: 14px;
            overflow: hidden;
            max-height: 60vh;
            width: fit-content;
        }

        .img-zoom {
            transition: transform 0.6s var(--spring-easing);
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .media-content:hover .img-zoom {
            transform: scale(1.05);
        }

        /* 滚动条 */
        ::-webkit-scrollbar { width: 0px; }

        /* 顶部模糊 */
        .top-blur {
            position: fixed;
            top: 0; left: 0; right: 0; height: 100px;
            background: linear-gradient(to bottom, var(--bg-color) 0%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 20%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 20%, transparent 100%);
            z-index: 30;
            pointer-events: none;
            transition: background 0.5s ease;
        }

        /* 按钮与交互 */
        .icon-btn-bg {
            background-color: var(--accent-icon-bg);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .sun-icon {
            transition: transform 0.4s var(--bouncy-easing);
        }
        .sun-btn:hover .sun-icon {
            transform: rotate(45deg) scale(1.2);
            color: #FFD60A; /* 保持太阳金色 */
        }
        
        /* 文本颜色类 */
        .text-secondary { color: var(--text-secondary); }
        .text-tertiary { color: var(--text-tertiary); }
        
        /* 灯箱 (Lightbox) */
        #lightbox {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            transition: opacity 0.3s ease;
        }
        #lightbox.hidden {
            pointer-events: none;
            opacity: 0;
        }
        #lightbox img {
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        
        /* 年份大标题颜色 */
        .year-title {
            color: var(--text-primary);
            opacity: var(--year-title-opacity);
            transition: color 0.5s ease, opacity 0.5s ease;
        }
    </style>
</head>
<body>

    <div id="parallax-bg"></div>
    <div class="top-blur"></div>

    <!-- 导航栏 -->
    <header class="fixed top-0 inset-x-0 z-40 px-6 py-8 flex justify-between items-end">
        <div>
            <p class="text-xs font-bold uppercase tracking-widest mb-1 text-secondary" id="dynamic-subtitle">MEMORIES</p>
            <h1 class="text-3xl font-black tracking-tight" id="user-display-name">许你九州山</h1>
        </div>
        <div class="flex items-center gap-3">
            <!-- 主题切换按钮 -->
            <button id="theme-toggle" class="w-12 h-12 rounded-2xl glass-container flex items-center justify-center p-2 active:scale-90 transition-transform cursor-pointer">
                <i data-lucide="moon" class="text-primary w-5 h-5 fill-current"></i>
            </button>
            <!-- Logo -->
            <div id="logo-box" class="w-12 h-12 rounded-2xl overflow-hidden glass-container flex items-center justify-center p-2">
                <i data-lucide="sparkles" class="text-primary"></i>
            </div>
        </div>
    </header>

    <!-- 上传区域 -->
    <section id="upload-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-3xl transition-opacity duration-500">
        <div class="max-w-xs w-full text-center space-y-10 reveal">
            <div class="space-y-4">
                <div class="w-24 h-24 mx-auto bg-gradient-to-br from-blue-500 to-indigo-600 rounded-[24%] shadow-2xl flex items-center justify-center">
                    <i data-lucide="cloud-moon" class="w-12 h-12 text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-white">开始回忆之旅</h2>
                <p class="text-white/60 text-sm leading-relaxed">
                    请选择你的“可话”备份文件夹<br>
                    我们将为你构建私密的时间画廊
                </p>
            </div>
            <label class="block">
                <input type="file" id="dir-picker" webkitdirectory directory multiple class="hidden">
                <div class="bg-white text-black py-4 px-8 rounded-full font-bold text-lg cursor-pointer hover:scale-105 active:scale-95 transition-all shadow-lg shadow-white/10">
                    载入文件夹
                </div>
            </label>
        </div>
    </section>

    <!-- 主流区域 -->
    <main id="app-content" class="max-w-2xl mx-auto pt-32 pb-40 px-5 space-y-12 relative z-10 hidden">
        <!-- 动态卡片插入处 -->
    </main>

    <!-- 底部状态栏 -->
    <footer id="status-bar" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-40 glass-container px-6 py-3 rounded-full hidden transition-colors duration-500">
        <p class="text-xs font-medium tracking-tight whitespace-nowrap text-primary">
            <span id="stat-count">0</span> 段时光 · <span id="stat-years">0</span> 个年份
        </p>
    </footer>

    <!-- 图片灯箱 (Lightbox) -->
    <div id="lightbox" class="fixed inset-0 z-[100] hidden flex items-center justify-center" onclick="closeLightbox()">
        <button class="absolute top-6 right-6 p-4 text-white hover:opacity-70 transition-opacity z-50">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
        <img id="lightbox-img" src="" class="max-w-[95vw] max-h-[90vh] object-contain rounded-md transition-transform duration-300 scale-95 opacity-0">
    </div>

    <script>
        // 初始化 Lucide 图标
        lucide.createIcons();

        const state = {
            entries: [],
            media: new Map(),
            bgImage: null,
            theme: 'dark'
        };

        const elements = {
            picker: document.getElementById('dir-picker'),
            uploadScreen: document.getElementById('upload-screen'),
            appContent: document.getElementById('app-content'),
            parallaxBg: document.getElementById('parallax-bg'),
            logoBox: document.getElementById('logo-box'),
            statCount: document.getElementById('stat-count'),
            statYears: document.getElementById('stat-years'),
            statusBar: document.getElementById('status-bar'),
            themeToggle: document.getElementById('theme-toggle'),
            html: document.documentElement,
            lightbox: document.getElementById('lightbox'),
            lightboxImg: document.getElementById('lightbox-img')
        };

        // --- 主题切换逻辑 ---
        elements.themeToggle.addEventListener('click', () => {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            elements.html.setAttribute('data-theme', state.theme);
            
            // 更新图标
            const icon = elements.themeToggle.querySelector('i'); // Lucide svg
            // 简单的图标切换：这里我们需要重新渲染图标或更改属性，因为Lucide是SVG注入
            elements.themeToggle.innerHTML = state.theme === 'dark' 
                ? `<i data-lucide="moon" class="text-primary w-5 h-5 fill-current"></i>`
                : `<i data-lucide="sun" class="text-primary w-5 h-5 fill-current text-yellow-500"></i>`;
            lucide.createIcons();
            
            // 亮色模式下Logo Box图标颜色调整
            const logoIcon = elements.logoBox.querySelector('svg');
            if(logoIcon) {
                logoIcon.style.color = state.theme === 'dark' ? '#fff' : '#000';
            }
        });

        // 视差滚动逻辑
        window.addEventListener('mousemove', (e) => {
            const moveX = (e.clientX - window.innerWidth / 2) * 0.01;
            const moveY = (e.clientY - window.innerHeight / 2) * 0.01;
            elements.parallaxBg.style.transform = `translate(${moveX}px, ${moveY}px) scale(1.1)`;
        });

        elements.picker.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;

            elements.uploadScreen.style.opacity = '0';
            setTimeout(() => elements.uploadScreen.classList.add('hidden'), 500);

            await processFiles(files);
        });

        async function processFiles(files) {
            const txtFiles = [];
            
            for (const file of files) {
                // 1. 识别背景 (优先星云或晨晕)
                if (file.name.includes('首页背景图') || file.name.includes('星云')) {
                    state.bgImage = URL.createObjectURL(file);
                    elements.parallaxBg.style.backgroundImage = `url(${state.bgImage})`;
                }

                // 2. 识别 Logo
                if (file.name.includes('logo_符号')) {
                    const logoUrl = URL.createObjectURL(file);
                    elements.logoBox.innerHTML = `<img src="${logoUrl}" class="w-full h-full object-contain">`;
                }

                // 3. 收集媒体
                if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
                    state.media.set(file.name, file);
                }

                // 4. 文本文件
                if (file.name.endsWith('-动态内容.txt')) {
                    txtFiles.push(file);
                }
            }

            for (const f of txtFiles) {
                const text = await f.text();
                parseContent(text);
            }

            state.entries.sort((a, b) => b.timestamp - a.timestamp);
            render();
            
            elements.appContent.classList.remove('hidden');
            elements.statusBar.classList.remove('hidden');
            elements.statCount.innerText = state.entries.length;
            elements.statYears.innerText = [...new Set(state.entries.map(e => new Date(e.timestamp).getFullYear()))].length;
        }

        function parseContent(text) {
            // 正则匹配: 2023年01月01日 08:38:44
            const datePattern = /^(\d{4}年\d{1,2}月\d{1,2}日\s\d{2}:\d{2}:\d{2})/gm;
            let match;
            let positions = [];

            while ((match = datePattern.exec(text)) !== null) {
                positions.push({ date: match[1], index: match.index });
            }

            positions.forEach((pos, i) => {
                const start = pos.index + pos.date.length;
                const end = positions[i+1] ? positions[i+1].index : text.length;
                let rawBody = text.substring(start, end).trim();

                const entry = {
                    date: pos.date,
                    timestamp: new Date(pos.date.replace(/年|月/g, '/').replace('日', '')).getTime(),
                    text: '',
                    media: []
                };

                // 解析媒体标签 [图片：xxx] [视频：xxx]
                const mediaRegex = /\[(图片|视频)[:：]\s*(.*?)\]/g;
                entry.text = rawBody.replace(mediaRegex, (m, type, filename) => {
                    entry.media.push({ type: type === '视频' ? 'video' : 'image', filename: filename.trim() });
                    return '';
                }).trim();

                state.entries.push(entry);
            });
        }

        // --- 图片展示核心逻辑修改 ---
        function render() {
            elements.appContent.innerHTML = '';
            let currentYear = '';

            state.entries.forEach((item, idx) => {
                const date = new Date(item.timestamp);
                const year = date.getFullYear();
                
                // 年份大标题
                if (year !== currentYear) {
                    const yEl = document.createElement('div');
                    yEl.className = 'text-5xl font-black pt-10 sticky top-24 pointer-events-none year-title';
                    yEl.innerText = year;
                    elements.appContent.appendChild(yEl);
                    currentYear = year;
                }

                const card = document.createElement('div');
                card.className = 'ios-card p-6 reveal';
                card.style.animationDelay = `${idx * 0.05}s`;

                // 日期信息
                const monthDay = `${date.getMonth() + 1}月${date.getDate()}日`;
                const time = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

                // 处理媒体
                let mediaHtml = '';
                if (item.media.length > 0) {
                    const images = item.media.filter(m => m.type === 'image');
                    const videos = item.media.filter(m => m.type === 'video');

                    mediaHtml += `<div class="mt-4 space-y-3">`;

                    // 1. 优先展示视频 (保持原有大卡片逻辑)
                    videos.forEach(m => {
                        const file = state.media.get(m.filename);
                        if (file) {
                            const url = URL.createObjectURL(file);
                            mediaHtml += `
                                <div class="media-content shadow-inner">
                                    <video controls class="w-full max-h-[70vh]" preload="metadata">
                                        <source src="${url}" type="${file.type}">
                                    </video>
                                </div>`;
                        }
                    });

                    // 2. 图片展示逻辑 (核心修改)
                    if (images.length > 0) {
                        if (images.length === 1) {
                            // 单张图：保持大图
                            const file = state.media.get(images[0].filename);
                            if (file) {
                                const url = URL.createObjectURL(file);
                                mediaHtml += `
                                    <div class="single-image-container media-content cursor-zoom-in group">
                                        <img src="${url}" class="w-full h-auto img-zoom" loading="lazy" onclick="openLightbox('${url}')">
                                    </div>`;
                            }
                        } else {
                            // 多张图：九宫格
                            // 特殊处理：如果是4张图，用2x2布局 (four-grid)，否则用3列布局
                            const gridClass = images.length === 4 ? 'grid-gallery four-grid' : 'grid-gallery';
                            
                            mediaHtml += `<div class="${gridClass}">`;
                            
                            images.forEach(m => {
                                const file = state.media.get(m.filename);
                                if (file) {
                                    const url = URL.createObjectURL(file);
                                    mediaHtml += `
                                        <div class="media-content aspect-square cursor-zoom-in group">
                                            <img src="${url}" class="img-zoom w-full h-full object-cover" loading="lazy" onclick="openLightbox('${url}')">
                                        </div>
                                    `;
                                }
                            });
                            
                            mediaHtml += `</div>`;
                        }
                    }

                    mediaHtml += `</div>`;
                }

                // 渲染卡片
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-secondary tracking-tighter">${time}</span>
                            <span class="text-lg font-bold tracking-tight text-[var(--text-primary)]">${monthDay}</span>
                        </div>
                        <div class="w-8 h-8 rounded-full icon-btn-bg flex items-center justify-center">
                            <i data-lucide="more-horizontal" class="w-4 h-4 text-secondary"></i>
                        </div>
                    </div>
                    <p class="text-[17px] leading-relaxed text-[var(--text-primary)] font-medium whitespace-pre-wrap">${item.text || ' '}</p>
                    ${mediaHtml}
                    <div class="mt-6 flex items-center justify-between border-t border-[var(--glass-border)] pt-4">
                        <button class="sun-btn flex items-center gap-2 group">
                            <div class="w-10 h-10 rounded-full icon-btn-bg flex items-center justify-center group-active:scale-90 transition-transform">
                                <i data-lucide="sun" class="sun-icon w-5 h-5 text-tertiary"></i>
                            </div>
                            <span class="text-xs font-bold text-tertiary">共鸣</span>
                        </button>
                        <div class="flex gap-2">
                             <div class="w-8 h-8 rounded-full icon-btn-bg flex items-center justify-center"><i data-lucide="message-circle" class="w-4 h-4 text-tertiary"></i></div>
                             <div class="w-8 h-8 rounded-full icon-btn-bg flex items-center justify-center"><i data-lucide="share-2" class="w-4 h-4 text-tertiary"></i></div>
                        </div>
                    </div>
                `;
                elements.appContent.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- 灯箱功能 ---
        function openLightbox(url) {
            elements.lightboxImg.src = url;
            elements.lightbox.classList.remove('hidden');
            // 简单的淡入动画
            requestAnimationFrame(() => {
                elements.lightboxImg.style.transform = 'scale(1)';
                elements.lightboxImg.style.opacity = '1';
                elements.lightbox.style.opacity = '1';
            });
        }

        window.closeLightbox = function() { // 挂载到window以便HTML onclick调用
            elements.lightboxImg.style.transform = 'scale(0.95)';
            elements.lightboxImg.style.opacity = '0';
            elements.lightbox.style.opacity = '0';
            
            setTimeout(() => {
                elements.lightbox.classList.add('hidden');
                elements.lightboxImg.src = '';
            }, 300);
        }
    </script>
</body>
</html>